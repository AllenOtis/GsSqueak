set -e 
. defStone.env

# Uncomment following two lines to bootstrap from scratch
# newExtent $GEMSTONE_NAME
# todeLoad $GEMSTONE_NAME

export upgradeDir=$GEMSTONE/upgrade

# The bootstrap script is divided into several phases:
#
#   The first phase is to install Metacello into the base image, install
#     remote tODE browsing and debugging support, create the GsSqueak user, 
#     and to install the Cypress-Environmental-Tools package
#     as SystemUser. The Cypress-Environmental-Tools package has extensions
#     to the Cypress loader that make it possible to specify which 
#     SymbolDictionary classes are supposed to be installed in as well as 
#     which environment is to be used for installing methods. The 
#     Cypress-Environmental-Tools package also has a class that contains
#     the scripts used for the second and third phases.
#
#   The second phase is to install the ProtoObject and Object classes into the 
#     GsSqueak user space.
#
#   The third phase is to install the environment 7 extension methods in the
#     standard GemStone classes that are being used by GsSqueak.
#
$GS_HOME/bin/startTopaz $GEMSTONE_NAME -l << EOF

#  login is as SystemUser

  set u SystemUser p swordfish
  login

#--------------------
#   Install Metacello
#--------------------
  input $upgradeDir/bootstrapMetacelloSupport.topaz
  commit
  run
  | smalltalkDict |
  smalltalkDict := SymbolDictionary new.
  smalltalkDict name: #SmalltalkDict.
  System myUserProfile symbolList insertObject: smalltalkDict at: 1. 
  GsCurrentSession currentSession symbolList insertObject: smalltalkDict at: 1.
%
  doit
  (Object
	subclass: 'Smalltalk'
	instVarNames: #(  )
	classVars: #(  )
	classInstVars: #(  )
	poolDictionaries: #()
	inDictionary: SmalltalkDict
	options: #())
		category: 'Kernel Smalltalk Compat';
		comment: '';
		immediateInvariant.
%
  commit
category: 'bootstrapGsDevKit'
classmethod: Smalltalk
  at: aGlobalName ifPresent: aBlock
  | glob |
  aGlobalName isNil
    ifTrue: [ ^ nil ].
  glob := GsSession currentSession symbolList objectNamed: aGlobalName.
  ^ glob ~~ nil
    ifTrue: [ aBlock value: glob ]
    ifFalse: [ glob ]
%
commit
#--------------------
#   Install remote tODE browsing and debugging support
#--------------------
  run
  Metacello new
    baseline: 'Tode';
    repository: 'cypressfiletree:$GS_HOME/shared/repos/tode/repository/';
    load: 'Tode-Remote-Server'.
%
  commit
#--------------------
#   Create GsSqueak user and symbol lists
#--------------------
$GS_HOME/bin/startTopaz $GEMSTONE_NAME -l << EOF

#  login is as SystemUser

  set u SystemUser p swordfish
  login
  run
| gsSqueak |
gsSqueak := AllUsers userWithId: 'GsSqueak' ifAbsent: [ nil ].
gsSqueak ~~ nil
  ifTrue: [
    AllUsers removeAndCleanup: gsSqueak.
    System commitTransaction.
 ].
(AllUsers
  addNewUserWithId: 'GsSqueak'
  password: 'swordfish')
    addPrivilege: #'CodeModification';
    addPrivilege: #'UserPassword';
    addPrivilege: #'OtherPassword';
    yourself.
%
  commit
  logout

#  login is as GsSqueak

  set u GsSqueak password swordfish
  login

  run
| symbolList userProfile |
userProfile := System myUserProfile.
symbolList := SymbolList new.
symbolList 
	createDictionaryNamed: #'GemStone' at: 0;
	createDictionaryNamed: #'Smalltalk' at: 0;
	yourself.
(symbolList objectNamed: #GemStone) 
  at: #System put: (Globals at: #System);
  at: #GemStoneError put: (Globals at: #GemStoneError);
  yourself.
userProfile symbolList: symbolList.
%
  commit
  logout

#  login is as SystemUser

  set u SystemUser p swordfish
  login

#--------------------
#   Install Cypress-Environmental-Tools package
#--------------------
  run
  Metacello new
    baseline: 'GsSqueak';
    repository: 'cypressfiletree:$GS_HOME/shared/repos/tode/repository/';
    load: 'Cypress-Environmental-Tools'.
%
  commit

#  login is as GsSqueak

  set u GsSqueak p swordfish
  login

#--------------------
#   PHASE 2 - install ProtoObject and Object as GsSqueak
#--------------------

  run
GsSqueakProofConcept installPhase2
  %
  commit

#  login is as SystemUser

  set u SystemUser p swordfish
  login

#--------------------
#   PHASE 3 - install SmallInteger extension methods
#--------------------

  run
GsSqueakProofConcept installPhase3
  %
  commit


  exit
EOF

