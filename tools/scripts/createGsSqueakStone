#!/bin/bash

set -ex
set -o pipefail

restore=false
restoreFast=false
while getopts "r f" opt; do
	case $opt in
		r) restore=true
		;;
		f) restoreFast=true
		;;
	esac
done

shift $((OPTIND-1))
name=$1;


function loadPackage() {
	todeIt $name mc load "$1" "filetree://$GS_HOME/shared/repos/BP2017RH1/$2" 2>&1 | parseTodeitOutput
}

function debugLoadPackage() {
	todeIt -D $name mc load "$1" "filetree://$GS_HOME/shared/repos/BP2017RH1/$2" 2>&1 | parseTodeitOutput
}

function loadSqueakPackage() {
	loadPackage "$1" "SqueakImport"
}

if $restoreFast
then
    todeRestore $name fast.dbf
else
if $restore
then
    todeRestore $name tode.dbf
else
    createStone -f $name 3.5.0
fi

startTopaz $name -l << EOF
set u SystemUser p swordfish
login
run
SystemObjectSecurityPolicy worldAuthorization: #write.
(AllUsers userWithId: 'DataCurator') addPrivilege: #'CompilePrimitives'.
%
run
GsCompilerClasses keysAndValuesDo: [:symbol : class | Globals at: symbol put: class ]
%
commit
logout
login

input $GS_HOME/server/stones/$name/product/upgrade/GsNMethodIr.gs

commit
logout
set u DataCurator p swordfish
login
method: Behavior
_clearSubclassesDisallowed
    self _unsafeAt: 2 put: (format bitAnd: (16r20 bitInvert))
%
send Behavior _clearSubclassesDisallowed

env 7
method: Class
name
    ^ self @env0: name
%

commit
logout
exit
EOF

loadPackage BPBugFixes "tools/bugfixes"
loadPackage MCEnvSwitch "tools/MCEnvSwitch"
loadPackage SqueakParser "parser"
loadPackage SqSuperclasses "tools/superclasses"
loadPackage SqueakEnvironments "tools/SqueakEnvironments"
loadSqueakPackage SqContext
loadSqueakPackage SqClassCreation
loadPackage Workspace "tools"
loadSqueakPackage BPGsTests

todeBackup $name fast.dbf
fi

startTopaz $name -l << EOF
login
run
MCEnv set: 7.
MCEnv useSqueakParser.
Environment initialize.
Object addClassVarName: 'DependentsFields'.
%
commit
logout
exit
EOF

loadSqueakPackage SqContext7
loadSqueakPackage SqBooleans
loadSqueakPackage SqClasses
startTopaz $name -l << EOF
login
run
(SqueakEnvironment at: #ProtoObject) _setSelfCanBeSpecial recompileAllMethodsUsingSqueakParserInEnv: 7.
%
commit
logout
exit
EOF

loadSqueakPackage SqExceptions
loadSqueakPackage SqNumbers
startTopaz $name -l << EOF
login
run
(SqueakEnvironment at: #Magnitude) _setSelfCanBeSpecial recompileAllMethodsUsingSqueakParserInEnv: 7.
(SqueakEnvironment at: #Number) _setSelfCanBeSpecial recompileAllMethodsUsingSqueakParserInEnv: 7.
(SqueakEnvironment at: #Integer) _setSelfCanBeSpecial recompileAllMethodsUsingSqueakParserInEnv: 7.
(SqueakEnvironment at: #ScaledDecimal) _setSelfCanBeSpecial recompileAllMethodsUsingSqueakParserInEnv: 7.
(SqueakEnvironment at: #Fraction) _setSelfCanBeSpecial recompileAllMethodsUsingSqueakParserInEnv: 7.
MCEnv useGemstoneParser.
%
commit
logout
exit
EOF

loadSqueakPackage SqBlock
loadSqueakPackage SqBlock

startTopaz $name -l << EOF
login 
run
MCEnv useSqueakParser.
%
commit
logout
exit
EOF

loadSqueakPackage SqKernel
loadSqueakPackage SqCharacter

startTopaz $name -l << EOF
login
run
SmalltalkImage newMethodFromSqueakString: 'addToStartUpList: anObject' inEnv: 7.
SmalltalkImage newMethodFromSqueakString: 'addToShutDownList: anObject' inEnv: 7.
SmalltalkImage newMethodFromSqueakString: 'removeFromStartUpList: anObject' inEnv: 7.
SmalltalkImage newMethodFromSqueakString: 'removeFromShutDownList: anObject' inEnv: 7.
UserGlobals at: #ByteString put: String.
UserGlobals at: #ByteSymbol put: Symbol.
UserGlobals at: #MethodDictionary put: GsMethodDictionary.
UserGlobals at: #CompiledMethod put: GsNMethod.
%
commit
logout
exit
EOF
loadSqueakPackage SqCollectionLiterals
loadSqueakPackage SqCollections
loadSqueakPackage CompiledMethod
loadSqueakPackage SqWeak
loadSqueakPackage '`System-Object Events`'
loadSqueakPackage '`System-Change Notification`'
loadSqueakPackage '`System-Support`'
loadSqueakPackage SUnit
loadSqueakPackage SqCompiler
# loadSqueakPackage '`Compiler-ParseNodes`'

todeBackup $name flag1
loadSqueakPackage '`Kernel-Processes-Variables`'
loadSqueakPackage '`Kernel-Numbers`'
loadSqueakPackage '`Kernel-Pools`'
loadSqueakPackage '`Graphics-converting`'
loadSqueakPackage '`Graphics-Primitives`'
todeBackup $name flag2
loadSqueakPackage '`Collections-Arrayed`'

# loadSqueakPackage '`VMMaker`'
# loadSqueakPackage '`Graphics-Display Objects`'
loadSqueakPackage SqKernelTestsNumbers

startTopaz $name -l << EOF
login
run
(SqueakEnvironment at: #SystemOrganization put: ((SqueakEnvironment at: #SystemOrganizer) @env7: defaultList: SqueakEnvironment allClasses))
%
commit
logout
exit
EOF
